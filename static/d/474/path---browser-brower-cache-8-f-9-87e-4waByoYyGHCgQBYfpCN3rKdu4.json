{"data":{"site":{"siteMetadata":{"title":"Blog","author":"susiezhao"}},"markdownRemark":{"id":"011da12e-8d10-561e-a98c-efb11ef9800b","excerpt":"…","html":"<h2>缓存策略</h2>\n<p>浏览器对所有请求的资源有一套完整的缓存策略，其主要分为三个部分，缓存存储策略，缓存失效策略以及缓存对比策略。</p>\n<ul>\n<li>缓存存储策略：发生在收到请求响应之后，用于决定是否对某个资源进行相应的缓存操作。</li>\n<li>缓存失效策略：发生在请求发送到服务器之前。用于决定是从浏览器缓存中获取资源还是从服务器请求资源。涉及的缓存方法是 <strong>强制缓存</strong> 和 <strong>启发式缓存</strong>。</li>\n<li>缓存对比策略：一定会发送请求到服务器，但是资源的获取是根据服务器的返回决定从浏览器缓存获取还是从服务器获取。涉及的缓存方法是 <strong>协商缓存</strong>。</li>\n</ul>\n<p><strong>注意：缓存失效策略和缓存对比策略的启用与否必须是建立在该资源存在缓存存储策略的基础上。</strong>\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2fbed026c18a268eba36b0e31c1f6df6/35c67/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 89.60000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAAB4klEQVQ4y32U54oCUQyF5/1fS1RQ/GNFbNh77zXyBY7cve5uINyZtHtykplktVpZqVSyXC5nvV7PXq+XLZdLq9VqVigUrNFouO12u9n9frf1em3lctmKxaJ1u90fPjQ5nU5eYDwe2+Fw8ABObJPJxDabjUkej4cdj0cDxGw2s91uZ6E8n09LqC6h2PV69ZtCwY4IReyT3wtut1tvr1qtegsgJokgAsIE7ACQTfbwTECkNngmgaJhGwoWV3+hw5+cz2drtVpWqVScR4rDH1qv190+HA5tv98b3cApg8lms675fN5t+Mh1hAxhPp/7CfEoAlKCsWsoICSHgbEVo9HI4/Bhdw47nY41m00PYHrcpAFQjC5ohxMfyTyjEmIvl4sltAI6boRHlBvhBOVZXJGA/ibEekFxBrrFYuFG0KDsGYjFHz4Qsw2DwcDb7ff7fhL7QYiz3W47+VyAg0tYJZThsFrwSSK2dDptqVTKMpmMfzXEQ8FnsSlCW+GuiRsNScgl8Ufhe6i9EjeaYpikGF0mIUd7+vXpCSFoYhQqqLX5tyBThBfWBh60d6DUjsIrhTnloxjvouZTECIZzHQ69cIEkaBvOVQVCm1fP4f47xG3HPvi+K/fV7h32nZQawCharFje6hvOOlx9gifKgkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"缓存策略流程图\"\n        title=\"\"\n        src=\"/static/2fbed026c18a268eba36b0e31c1f6df6/b9e4f/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB.png\"\n        srcset=\"/static/2fbed026c18a268eba36b0e31c1f6df6/cf440/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB.png 148w,\n/static/2fbed026c18a268eba36b0e31c1f6df6/d2d38/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB.png 295w,\n/static/2fbed026c18a268eba36b0e31c1f6df6/b9e4f/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB.png 590w,\n/static/2fbed026c18a268eba36b0e31c1f6df6/35c67/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB.png 750w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>HTTP 首部字段</h2>\n<table>\n<thead>\n<tr>\n<th>首部字段</th>\n<th align=\"right\">值</th>\n<th align=\"center\">描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Expires</td>\n<td align=\"right\"><code>Expires: Sat, 24 Aug 2019 04:43:11 GMT</code></td>\n<td align=\"center\">指定缓存过期的时间，与缓存储存策略和缓存过期策略相关，指定缓存过期的时间，绝对时间，存在服务器和客户端时期不一致进而导致缓存的不正确</td>\n</tr>\n<tr>\n<td>Cache-Control</td>\n<td align=\"right\">常用的值由 <code>Cache-Control: max-age=60,public,private,no-cache,no-store,must-revalidate</code></td>\n<td align=\"center\">该首部字段涉及了缓存存储策略，缓存过期策略以及缓存对比策略，比较复杂，下文单独说明</td>\n</tr>\n<tr>\n<td>Last-Modified</td>\n<td align=\"right\"><code>Last-Modified: Sat, 24 Aug 2019 04:43:11 GMT</code></td>\n<td align=\"center\">响应首部字段，表示资源的最后修改时间</td>\n</tr>\n<tr>\n<td>If-Modified-Since</td>\n<td align=\"right\"><code>If-Modified-Since: Sat, 24 Aug 2019 04:43:11 GMT</code></td>\n<td align=\"center\">请求的首部字段，其值由上一次响应的 Last-Modified 决定，如果资源在指定时间之后未发生修改，服务器返回 304 Not Modified，否则返回新的资源并更新浏览器缓存</td>\n</tr>\n<tr>\n<td>If-Unmodified-Since</td>\n<td align=\"right\"><code>If-Unmodified-Since: Sat, 24 Aug 2019 04:43:11 GMT</code></td>\n<td align=\"center\">请求的首部字段，其值由上一次响应的 Last-Modified 决定，如果资源在指定时间之后发生修改，服务器返回 412 Precondition Failed，否则返回新的资源并更新浏览器缓存</td>\n</tr>\n<tr>\n<td>Etag</td>\n<td align=\"right\"><code>Etag: xxxxxx</code></td>\n<td align=\"center\">请求资源的唯一标识字符串</td>\n</tr>\n<tr>\n<td>If-No-Match</td>\n<td align=\"right\"><code>If-No-Match: xxxxxx</code></td>\n<td align=\"center\">缓存协商校验字段，请求资源的唯一标识字符串，为上次请求收到的ETag的值，如值没有发生变化，服务器返回 304 Not Modified，否则返回新的资源并更新浏览器缓存</td>\n</tr>\n<tr>\n<td>If-Match</td>\n<td align=\"right\"><code>If-Match: xxxxxx</code></td>\n<td align=\"center\">缓存协商校验字段，请求资源的唯一标识字符串，为上次请求收到的ETag的值，如果值未发生变化，返回新的资源并更新浏览器缓存， 否则服务器返回 412 Precondition Failed，</td>\n</tr>\n</tbody>\n</table>\n<h3>Cache-Control 首部字段</h3>\n<p>Cache-Control 用于指定资源的缓存策略，可以同时在请求头和响应头中设置。其同时涉及缓存存储，缓存过期以及缓存对比这三个策略，其取值如下：</p>\n<ul>\n<li><code>max-age=xx</code>： 设置缓存过期时间，是一个相对时间，单位为秒， 即在xx秒后缓存失效。此时采用强缓存方法，当 <code>max-age=0</code> 的时候采用协商缓存方法。当 <code>Expires: xxxxxxx</code> 和 <code>Cache-Control: max-age=xxx</code> 同时出现时， Cache-Control 的优先级更高；</li>\n<li><code>public</code>：该资源可以被客户端，代理服务器缓存，即缓存资源是所有人都可见的；</li>\n<li><code>private</code>：该资源只能被客户端缓存，代理服务器不允许缓存，即缓存资源只针对特定用户可见；</li>\n<li><code>no-cache</code>： 资源可以被缓存，但是每次请求时都必须向服务器发起协商缓存；其等价于 <code>max-age=0;must-revalidate</code>；</li>\n<li><code>no-store</code>：该资源不允许被缓存，客户端，代理服务器都不允许缓存，每次都需要从服务器端获取资源；</li>\n<li><code>must-revalidate</code>：资源可缓存，浏览器必须向服务器发送请求，验证资源是否还有效存。</li>\n</ul>\n<h2>缓存方法</h2>\n<h3>强制缓存</h3>\n<p>强制缓存：当客户端请求后，会先访问缓存数据库看缓存是否存在。如果存在则直接返回；不存在则请求真的服务器，响应后再写入缓存数据库。</p>\n<p>与强制缓存相关的 HTTP 首部字段： <code>Expires</code> 与 <code>Cache-Control</code>；设置缓存过期的时间， <code>Cache-Control</code> 的优先级高于 <code>Expires</code>。</p>\n<h3>启发式缓存</h3>\n<p>启发式缓存：当缓存过期时间的字段一个都没有的时候，浏览器下次并不会直接进入协商阶段，而是先进入启发式缓存阶段，你可以通过关闭服务器，刷新页面来观察。它根据响应头中2个时间字段 <code>Date</code> 和 <code>Last-Modified</code> 之间的时间差值，取其值的 <strong>10%</strong> 作为缓存时间周期。也就是说，当存有 <code>Last-Modified</code> 字段的时候，即使是断网，且强缓存都失效后，也有一定时间是直接读取缓存文件的。</p>\n<h3>协商缓存</h3>\n<p>当浏览器对某一个资源没有命中强制缓存时，则会启动协商缓存，即向服务器发送一个请求验证该资源的是否有更新，没有更新则返回 304 Not Modified，并从浏览器本地缓存数据库获取资源，否则从服务器返回资源，并更新缓存数据库。</p>\n<p>与协商缓存相关的 HTTP 首部字段：  </p>\n<ul>\n<li><code>Last-Modified &#x26; If-Modified-Since</code>：浏览器第一次请求一个资源的时候，服务器返回的 header 中会加上<code>Last-Modify</code>，<code>Last-modify</code> 是一个时间标识该资源的最后修改时间，例如 <code>Last-Modify: Thu,31 Dec 2037 23:59:59 GMT</code>。当浏览器再次请求该资源时，request 的请求头中会包含 <code>If-Modify-Since</code>，该值为缓存之前返回的<code>Last-Modify</code>。服务器收到 <code>If-Modify-Since</code> 后，根据资源的最后修改时间判断是否命中缓存。如果命中缓存，则返回304，并且不会返回资源内容，并且不会返回 <code>Last-Modify</code>；</li>\n<li><code>Etag &#x26; If-No-Match</code>：<code>Etag &#x26; If-None-Match</code>返回的是一个校验码。<code>ETag</code> 可以保证每一个资源是唯一的，资源变化都会导致 <code>ETag</code> 变化。服务器根据浏览器上送的 <code>If-None-Match</code> 值来判断是否命中缓存。与 <code>Last-Modified</code> 不一样的是，当服务器返回304 Not Modified 的响应时，由于 <code>ETag</code> 重新生成过，response header 中还会把这个 <code>ETag</code> 返回，即使这个 <code>ETag</code> 跟之前的没有变化。</li>\n</ul>\n<p>** <code>Etag &#x26; If-No-Match</code> 优先级高于 <code>Last-Modified &#x26; If-Modified-Since</code>**</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2a19615af3a8335f844fafe5b1bc8944/dfd8d/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 59.07692307692308%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB80lEQVQoz41Tia6bMBDM/39Y1SqKmjtcARJCOG0uGwgQpmvy8l6TVmpXWnmFvOOZ2WU2jiPeI0kTuOcTbMeG4zjw/Au8i4e8yMEzjjRJwFiKPMuQ0l0pxNSnsGaquFMhZI1KSDRtj8iP4ek2XI0ADRcupWdfkHgR4oCBlTVYUYOXzXSW8vYK2HYDvCDF2Y/AqxbOKYRj+wjCjB7qIUQHSWdV3SDrHk9N6hzuIxF6gKmYqaIfvmTXTYP5cofFWsPWcGAcbeiGAcO04LgnaLqOg6Zjtd7ANI9gPKP+4ZWheuUZRVVjtdWw00zoloPFcgvL8XCNGIKYI8mqSWaSCXAllxh3w/0LMGUcVdPD8UIESU4XJRY/N/ixWGKvH6fULPLRCwiUT/b8LT4ls1xCNANE3aC99cjIcM20sdzs4Qcx/ifGB+ID8Cn5KTovBdY7nSRbE6swDHGltfFpbTLOwNkj4zii9YnB6ds4/ib5fShFJYndgUA1GohLJw3EPuN48pGSbwWtSC5a5FUzqVF+dv39dSg38iWIElrakkzuJqkH3cKcfPz2fY4VyVfgYUI7mJdgdC/hBWTTTStz/5D7CagY8lItaIeYC5juFau9heM5nBiluSAm8sHsIzNiKGiYfwzl/dcTdQs/UkwENXT/Hgj1PyFU/QsZmpS/30DOswAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"浏览器缓存xmind\"\n        title=\"\"\n        src=\"/static/2a19615af3a8335f844fafe5b1bc8944/b9e4f/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png\"\n        srcset=\"/static/2a19615af3a8335f844fafe5b1bc8944/cf440/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png 148w,\n/static/2a19615af3a8335f844fafe5b1bc8944/d2d38/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png 295w,\n/static/2a19615af3a8335f844fafe5b1bc8944/b9e4f/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png 590w,\n/static/2a19615af3a8335f844fafe5b1bc8944/f9b6a/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png 885w,\n/static/2a19615af3a8335f844fafe5b1bc8944/2d849/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png 1180w,\n/static/2a19615af3a8335f844fafe5b1bc8944/bbefa/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png 1770w,\n/static/2a19615af3a8335f844fafe5b1bc8944/dfd8d/%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88%E5%9B%BE.png 1950w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>参考文献</h2>\n<p><a href=\"\">1</a></p>","frontmatter":{"title":"浏览器的缓存","date":"August 24, 2019","description":"浏览器缓存相关知识点"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/browser/brower_cache/","previous":{"fields":{"slug":"/grafana/app_develop/"},"frontmatter":{"title":"基于腾讯云监控 API 的 Grafana App 插件开发"}},"next":null}}