{"data":{"site":{"siteMetadata":{"title":"Blog","author":"susiezhao"}},"markdownRemark":{"id":"f2cb7447-4273-54aa-9e3c-8106caaaeb77","excerpt":"Grafana 是一个开源的时序性统计和监控平台，支持例如 elasticsearch、graphite、influxdb 等众多的数据源，并以功能强大的界面编辑器著称，允许您对指标进行查询、可视化展示、设置告警等操作，以及自定义配置仪表盘。  Grafana…","html":"<p>Grafana 是一个开源的时序性统计和监控平台，支持例如 elasticsearch、graphite、influxdb 等众多的数据源，并以功能强大的界面编辑器著称，允许您对指标进行查询、可视化展示、设置告警等操作，以及自定义配置仪表盘。 </p>\n<p>Grafana 已经拥有一个强大的贡献者和插件开发者社区。开发者社区提供了三种类型的插件： </p>\n<ul>\n<li>Panel Plugin: 针对图形展示的面板插件；</li>\n<li>Datasource Plugin: 针对数据源的插件；</li>\n<li>App Plugin: 针对完整应用的插件，通常由 Panel Plugin，Datasource Plugin 以及 Dashboards 模板组成；</li>\n</ul>\n<h1>Grafana APP 插件的目录结构及配置文件</h1>\n<p>本文主要介绍的是 App Plugin 的开发过程以及相关的代码组织。基于腾讯云云监控 API 的 Tencent Cloud Monitor App 插件(<a href=\"https://github.com/TencentCloud/tencentcloud-monitor-grafana-app\">TencentCloud/tencentcloud-monitor-grafana-app</a>)，主要由两部分组成： Datasource Plugin 和 Dashboards 模板组成，代码的目录结构如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">.\n├── CHANGELOG.md\n├── LICENSE\n├── README.md\n├── dist                                        // 文件夹，文件夹 src 打包后的代码\n├── package.json\n├── src\n│   ├── components\n│   │   ├── config.html\n│   │   └── config.ts\n│   ├── dashboards                              // Dashboards 典型模板存放\n│   │   ├── example_cdb_dashboard.json\n│   │   └── example_cvm_dashboard.json\n│   ├── datasource                              // Datasource Plguin 代码\n│   │   ├── __mocks__\n│   │   │   └── core_module.ts\n│   │   ├── common\n│   │   │   ├── constants.ts\n│   │   │   └── sign.ts\n│   │   ├── components                          // 自定义的 Angular 组件\n│   │   │   ├── custom_select_dropdown.ts\n│   │   │   └── multi_condition.ts\n│   │   ├── css\n│   │   │   └── query_editor.css\n│   │   ├── config.ctrl.ts                       // ConfigCtrl 模块\n│   │   ├── datasource.ts                        // Datasource 模块\n│   │   ├── query.ctrl.ts                        // QueryCtrl 模块\n│   │   ├── img\n│   │   │   └── tencent-cloud.svg\n│   │   ├── partials                             // Datasource Plugin 中的 html 页面\n│   │   │   ├── config.html                      // config.ctrl.ts 对应的 html\n│   │   │   ├── query.editor.html                // query.ctrl.ts 对应的 html\n│   │   ├── module.ts                            // Datasource Plguin 的 module.ts\n│   │   ├── plugin.json                          // Datasource Plguin 的 module.ts\n│   │   ├── specs                                // 测试用例文件夹\n│   │   │   ├── tc_monitor_cdb_datasource.test.ts\n│   │   │   └── tc_monitor_cvm_datasource.test.ts\n│   │   └── tc_monitor                           // 云监控相关的产品\n│   │       ├── cdb\n│   │       │   ├── datasource.ts\n│   │       │   ├── query.ts\n│   │       │   └── query_def.ts\n│   │       ├── cvm\n│   │       │   ├── datasource.ts\n│   │       │   ├── query.ts\n│   │       │   └── query_def.ts\n│   │       └── index.ts\n│   ├── image                                    // 文件夹，存放README.md 中图片\n│   ├── img\n│   │   └── tencent-cloud.svg\n│   ├── module.ts                                // App Plguin 的 module.ts\n│   └── plugin.json                              // App Plugin 的 plugion.json\n├── jest.config.js                               // jest 框架的配置信息\n├── tsconfig.jest.json\n├── tsconfig.json\n├── tslint.json\n├── webpack.config.analyze.js\n├── webpack.config.js\n└── webpack.config.prod.js</code></pre></div>\n<p>在每个 Plugin 开发中存在两个重要的配置文件： <strong>plugin.json</strong> 和 <strong>module.ts</strong>。</p>\n<h2>plugin.json</h2>\n<p> <code>plugin.json(Required)</code>: 用于描述插件的相关信息。在 Grafana 服务启动时会扫描所有的插件文件夹并挂载每个插件的 dist 目录，并查找 <code>plugin.json</code> 文件，根据文件的内容完成插件的自动注册。  </p>\n<p>在 Tencent Cloud Monitor App 中存在两种类型的 Plugin, 其配置文件如下：\nApp Plugin 中配置 <code>plugion.json</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"app\"</span><span class=\"token punctuation\">,</span>                                          <span class=\"token comment\">// 插件的类型： panel | app | datasource</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Tencent Cloud Monitor\"</span><span class=\"token punctuation\">,</span>                        <span class=\"token comment\">// 插件名称</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tencentcloud-monitor-app\"</span><span class=\"token punctuation\">,</span>                       <span class=\"token comment\">// 插件ID, 必须唯一</span>\n  <span class=\"token property\">\"info\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Tencent Cloud Monitor App for Grafana\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"author\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Tencent Cloud\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"keywords\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"tencentcloud\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"tencentcloudmonitor\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"grafana\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"plugins\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"logos\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"small\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"img/tencent-cloud.svg\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"large\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"img/tencent-cloud.svg\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"updated\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2019-04-10\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"includes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>                                            <span class=\"token comment\">// App Plugin 中包含的 Datasource Plugin 和 Dashboards 模板信息</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dashboard\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"【实例】CDB 单机监控\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dashboards/example_cdb_dashboard.json\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dashboard\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"【实例】CVM 单机监控\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dashboards/example_cvm_dashboard.json\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"datasource\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Tencent Cloud Monitor Datasource\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"grafanaVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"plugins\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Datasource Plugin 中配置 <code>plugin.json</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"datasource\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Tencent Cloud Monitor Datasource\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tencentcloud-monitor-datasource\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"metrics\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>                           <span class=\"token comment\">// Datasource plugin 特有的属性，是否在 panel 中支持 metrics</span>\n  <span class=\"token property\">\"annotations\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>                       <span class=\"token comment\">// Datasource plugin 特有的属性，是否在 dashboard 中支持 annotations 查询</span>\n  <span class=\"token property\">\"queryOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"maxDataPoints\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"routes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"info\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"author\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Tencent Cloud\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"logos\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"small\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"img/tencent-cloud.svg\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"large\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"img/tencent-cloud.svg\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>特别注意</strong> Datasource Plugin 的 <code>plugin.json</code> 配置中必须存在 <strong>metric</strong> 和 <strong>annotations</strong>，且其中至少有一个属性的值为 <code>true</code>。</p>\n<h2>module.ts</h2>\n<p><code>module.ts</code>：Plugin 入口文件，决定了插件的具体实现的。根据插件的类型不同其内容也有所差异。 </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* App Plugin 的 module.ts 需要导出1个模块 */</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span>\n  ConfigCtrl<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* Datasource Plugin 的 module.ts 通常需要导出5个模块 */</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span>\n  Datasource<span class=\"token punctuation\">,</span>                 <span class=\"token comment\">// Required</span>\n  ConfigCtrl<span class=\"token punctuation\">,</span>                 <span class=\"token comment\">// Required</span>\n  QueryCtrl<span class=\"token punctuation\">,</span>                  <span class=\"token comment\">// Required</span>\n  AnnotationsQueryCtrl<span class=\"token punctuation\">,</span>\n  QueryOptionsCtrl\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1>Grafana APP 开发实践</h1>\n<p>基于腾讯云云监控 API 的 Tencent Cloud Monitor App 完整的结构图如下所示：<br>\n<a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9a1a042e560c6857c469bef52b5685ce/5edb4/grafana_app.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 70.06493506493506%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsSAAALEgHS3X78AAAC1klEQVQ4y32UWU8aURTHqSsqiAIzDNsMIMpStzZxoVTsk4pL0qbW1C19ao0foZ+iaT+Cfa+J8ckmJtJHn2yEiC0uEYmaiGF5UCL8e+5FG1Mbz+TmhLn/+Z3/mTkXVW8ghN7uLjxu74TH44XJZIZeb4BaXYeVlRUkk0lEo1Gw+La8DPlJCH39QQSfdqKvsx0uhxOiaIJGU48PCwtQ+RU7nJKI5mYjGho0tKGlrEVFRRVWV1dxcZHG+fk5By4tfSWdgUMUkwipSQedVguNTg/J4sfiewJ+nJnD69EJDIdHMTY2frMmMDQ0gs3NTZRKJeRyOQ5cW/uO4eEwJt9MITw6jjDpuH7iJd7OLuLLp89Q4YHI5/NIp9O8beby8vKS32dF/o3r6wJKdKmKtFksFu8tFnt7e9jZ2cHp6SnOzs6QyWRQKBRwdXXF8139bZEHHTJniUSCg26LPBQMqioWr5HYP8TvxD4ODg6wu/sL8Xicg1je2triQNYu+9qxWIxcx7G9vc33otEY5Z/07GHZYT6XxeDIK/i6+9Hd1YW2Ni9crhbY7TJk2YGqqmqsr6/j5OQEeoMIoyDRmEj8azc2NvGsUj3C5OTUDZBe/LNAABbJDLPFBrPZCkEwQaLfoiCisrIaGxsRJI+OIMluONw+PqdGo8jBTK9W12OGpoUD2UgEn4fgcLq5I6vVBpNkgZXgNguJ6xoQifzA8fExmvVGWG0KnKRVHC44aLlbPdBodZiff1cGZrNZDIRewGZX/rrT04NaEjEHrHokEkEqlYKGBp4V9fk7eKsGg0CdWFBbW0cOZ+84DIYgMyBNv9Fo4lAGY+Iy8NahAFlx0Tt28+Jmsw0erx86TeOdlrM5BAYH4HYqaLXJEOgss7N5H5jirq2kafP4ac8Ki5WOLcHZUZ2bm78BZgg4PoCejhb0KC0wEkQU/g/UkBNZccLra+ftssX+TGpq1JieLrf8B3fNrt/F18X3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Tencent Cloud Monitor App 的结构图\"\n        title=\"\"\n        src=\"/static/9a1a042e560c6857c469bef52b5685ce/b9e4f/grafana_app.png\"\n        srcset=\"/static/9a1a042e560c6857c469bef52b5685ce/cf440/grafana_app.png 148w,\n/static/9a1a042e560c6857c469bef52b5685ce/d2d38/grafana_app.png 295w,\n/static/9a1a042e560c6857c469bef52b5685ce/b9e4f/grafana_app.png 590w,\n/static/9a1a042e560c6857c469bef52b5685ce/f9b6a/grafana_app.png 885w,\n/static/9a1a042e560c6857c469bef52b5685ce/2d849/grafana_app.png 1180w,\n/static/9a1a042e560c6857c469bef52b5685ce/5edb4/grafana_app.png 1540w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n      </p>\n<p>在整个应用开发中最为重要的部分是 Datasource Plugin 模块的开发，下面我们以该模块为例详细介绍。</p>\n<h2>Datasource Plugin 的开发</h2>\n<p>Datasource 插件中有3个必须的模块：<code>Datasource</code>、 <code>QueryCtrl</code> 和 <code>ConfigCtrl</code>；<br>\n<a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8d31ceb3f2953231049991ba36b35f9/0eed5/datasource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 29.08458864426419%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAA90lEQVQY022Qy26DMBBF+f9/qlRllXZBgBRIwxubYIwDBhPMy7hOUqqq6tHV1Wxm5s5o6yq/Je+IR/GUfLgQKyY0x1eIcJhkfpQGMYSITLPQ5C9msZ5AbXiF4Rf6Ge1t8OZkgPR+gqxTfPxM9A9/tzdMJxjGWQ3VnLRxU+qCxorqlHA+LjWbaDfVbKzYoLzjC2kHXN2qlldtT2hHu+GZS9tZ+auZKb0coAuYyh9cWivAdkTuHl9ND73bMEZMbrf8oLX9wgbBuKhvi3LKxqzsYMkAZglqlEDBWD/Ni9i+o9ia/9zsZY0VlnZMjmF58JB+ztV+Pgr5H18o81EbMljENAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"完整的 Datasource Plugin\"\n        title=\"\"\n        src=\"/static/e8d31ceb3f2953231049991ba36b35f9/b9e4f/datasource.png\"\n        srcset=\"/static/e8d31ceb3f2953231049991ba36b35f9/cf440/datasource.png 148w,\n/static/e8d31ceb3f2953231049991ba36b35f9/d2d38/datasource.png 295w,\n/static/e8d31ceb3f2953231049991ba36b35f9/b9e4f/datasource.png 590w,\n/static/e8d31ceb3f2953231049991ba36b35f9/0eed5/datasource.png 863w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>Datasource 模块</h3>\n<p>Datasource 模块主要负责与数据源的通信，每个 Datasource Plugin 的 Datasource 模块都必须遵循 Grafana 协议约定，存在下面这几个必须的功能函数：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span>             <span class=\"token comment\">// Required, used by panels to get data</span>\n<span class=\"token function\">testDatasource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>           <span class=\"token comment\">// Required, used by datasource configuration page to make sure the connection is working</span>\n<span class=\"token function\">annotationQuery</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span>   <span class=\"token comment\">// used by dashboards to get annotations</span>\n<span class=\"token function\">metricFindQuery</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span>   <span class=\"token comment\">// used by query editor to get metric suggestions.</span></code></pre></div>\n<p>在基于 Tencent Cloud Monitor App 的数据模块，针对不同的云产品，都必须有一个 Datasource 模块，因此我们定义了一个 Datasource 模块的协议，每个产品的 Datasource 模块都必须遵循这个接口协议：  </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">DatasourceInterface</span> <span class=\"token punctuation\">{</span>\n  instanceSettings<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>\n  backendSrv<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>\n  templateSrv<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">query</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">testDatasource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">metricFindQuery</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">getRegions</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">getMetrics</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">getInstances</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  getZones<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">service<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> any<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Datasource 模块的主要代码：  </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* Datasource Plugin 中的 datasource 模块 */</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Datasources<span class=\"token punctuation\">,</span> <span class=\"token constant\">SERVICES</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./tc_monitor'</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// Datasources 是每个云产品的 Datasource 组成的对象</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TCMonitorDatasource</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DatasourceInterface</span> <span class=\"token punctuation\">{</span>\n  instanceSettings<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>\n  backendSrv<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>\n  templateSrv<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/** @ngInject */</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instanceSettings<span class=\"token punctuation\">,</span> backendSrv<span class=\"token punctuation\">,</span> templateSrv</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>instanceSettings <span class=\"token operator\">=</span> instanceSettings<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>backendSrv <span class=\"token operator\">=</span> backendSrv<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>templateSrv <span class=\"token operator\">=</span> templateSrv<span class=\"token punctuation\">;</span>\n    _<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>Datasources<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_class<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>                   <span class=\"token comment\">// 自动实例化每个云产品的 Datasource 类</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">_class</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>instanceSettings<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>backendSrv<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>templateSrv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">testDatasource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>                 <span class=\"token comment\">// 根据选中的云产品去调用每个云产品 Datasource 类中对应的 testDatasource()</span>\n  <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>                   <span class=\"token comment\">// 根据选中的云产品去调用每个云产品 Datasource 类中对应的 query()</span>\n  <span class=\"token function\">metricFindQuery</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">query</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>           <span class=\"token comment\">// 根据选中的云产品去调用每个云产品 Datasource 类中对应的 getRegions()</span>\n  <span class=\"token function\">getRegions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>                     <span class=\"token comment\">// 根据选中的云产品去调用每个云产品 Datasource 类中对应的 getMetrics()</span>\n  <span class=\"token function\">getMetrics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>                     <span class=\"token comment\">// 根据选中的云产品去调用每个云产品 Datasource 类中对应的 getZones()</span>\n  <span class=\"token function\">getInstances</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">getZones</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/*CVM 产品中的 datasource 模块*/</span> \n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CVMDatasource</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">DatasourceInterface</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">testDatasource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">metricFindQuery</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">query</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">getRegions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">getMetrics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">getInstances</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token function\">getZones</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>此时新增产品则需要在 <code>tc_monitor</code> 文件夹实现各自的 <code>datasource.ts</code> 类，同时每个类都遵循统一的 <code>DatasourceInterface</code> 协议即可。\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ff56a7d7f75b3e6331100e5574af9e4c/05c6f/grafana_datasource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 60.75949367088608%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAABMElEQVQoz6WTa6uCQBCG/f+/KgIp+yCKppKggpJWXsASb+XEO7CyeTwfTmdg2GV25tm57CokyTRNvFZVRVEU0WazIU3TyDAM2m63dL1e6fF4fPguRVkDpmlKnufR+XyeAZDn80ld1/0dmGUZ+b7/I5uvgcgwCALK83wG/At4uVy4h0VRUNu23wHhIGeIkuM4pr7vfwWuQRX5UDhgGKfTiacqy+v1mi+QY2SwsnaQJAm5rss9HMeRIcMwcPlN09CyKlkZiJuFAYH3+50DUR6A8h5w7OEnEkC8YCjLktYEvVsODzZxwUcPwzCkw+FAu92O9Xg88nQRYNs22/BbdF0nx3Hmt2lZFv+e/X7P56ZpkqqqpNxuN4LiqWBF3+q65pIwFKHCT/QQe9jxTRFbliX3/Q06faEpv6dkBwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Tencent Cloud Monitor App 的 Datasource Plugin 的 Datasource\"\n        title=\"\"\n        src=\"/static/ff56a7d7f75b3e6331100e5574af9e4c/b9e4f/grafana_datasource.png\"\n        srcset=\"/static/ff56a7d7f75b3e6331100e5574af9e4c/cf440/grafana_datasource.png 148w,\n/static/ff56a7d7f75b3e6331100e5574af9e4c/d2d38/grafana_datasource.png 295w,\n/static/ff56a7d7f75b3e6331100e5574af9e4c/b9e4f/grafana_datasource.png 590w,\n/static/ff56a7d7f75b3e6331100e5574af9e4c/05c6f/grafana_datasource.png 711w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>QueryCtrl 模块</h3>\n<p>QueryCtrl 模块也是一个 JavaScript 类，当用户在 Dashboard 页面对 Panel 进行编辑时，它将被实例化并作为 Angular 控制器处理，并根据类中的 <code>templateUrl</code> 去加载对应的 View 视图，以图形化的界面提供接口数据查询逻辑。这个类必须继承自 <strong>grafana/app/plugins/sdk</strong>。具体页面展示以及主要代码逻辑如下：\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a1e1e8882fa39cf3ebf9742e06a11e44/0478f/panel_query.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 35.04842615012107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA2UlEQVQoz41Ry47CMAzMFUoTaJ5uAt3SrIp6gP//utk4IBYhIXoYjW1ZM36IkSy0tpDqAG0crPVQJd5ud1+x2TRoW4W+j4jxCOc8xPWSsdceFAeYIshiXWeqyRp0D+ZBmMU8L9B0RF5uaHeyCjoXagMbmMIcuwe/47XO/WI6TzhYwjDN8J6eCKFH/r1gSAmBayUPX8CDCCkVpNzXwrJccc4ziBJOpxHjmBH7VPM14EFE07RPQRZLRFDFxJj/NeyHdd9Rb8jfYkFWH36mKsxPubvG+53KKmvA5n+TS7AOOwRqjQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Tencent Cloud Monitor App 的 Datasource Plugin 的 QueryCtrl查询配置\"\n        title=\"\"\n        src=\"/static/a1e1e8882fa39cf3ebf9742e06a11e44/b9e4f/panel_query.png\"\n        srcset=\"/static/a1e1e8882fa39cf3ebf9742e06a11e44/cf440/panel_query.png 148w,\n/static/a1e1e8882fa39cf3ebf9742e06a11e44/d2d38/panel_query.png 295w,\n/static/a1e1e8882fa39cf3ebf9742e06a11e44/b9e4f/panel_query.png 590w,\n/static/a1e1e8882fa39cf3ebf9742e06a11e44/f9b6a/panel_query.png 885w,\n/static/a1e1e8882fa39cf3ebf9742e06a11e44/2d849/panel_query.png 1180w,\n/static/a1e1e8882fa39cf3ebf9742e06a11e44/bbefa/panel_query.png 1770w,\n/static/a1e1e8882fa39cf3ebf9742e06a11e44/0478f/panel_query.png 3304w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TCMonitorDatasourceQueryCtrl</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">QueryCtrl</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">static</span> templateUrl <span class=\"token operator\">=</span> <span class=\"token string\">'datasource/partials/query.editor.html'</span><span class=\"token punctuation\">;</span>\n  datasource<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>                  <span class=\"token comment\">// 对应 datasource.ts 实例的对象</span>\n  panelCtrl<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>                   <span class=\"token comment\">// 对应 Panel 的实例对象</span>\n  target<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>                         <span class=\"token comment\">// 具体的查询条件信息保存</span>\n    refId<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">;</span>\n    namespace<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">;</span>\n    service<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">;</span>\n    showInstanceDetails<span class=\"token punctuation\">:</span> boolean<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  defaults <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>                      <span class=\"token comment\">// 初始化值</span>\n    namespace<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    service<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    showInstanceDetails<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span>InitServiceState<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  lastQuery<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">;</span>\n  lastQueryError<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/** @ngInject */</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">$scope<span class=\"token punctuation\">,</span> $injector<span class=\"token punctuation\">,</span> <span class=\"token keyword\">private</span> templateSrv</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>$scope<span class=\"token punctuation\">,</span> $injector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    _<span class=\"token punctuation\">.</span><span class=\"token function\">defaultsDeep</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>panelCtrl<span class=\"token punctuation\">.</span>events<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'data-received'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">onDataReceived</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> $scope<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Panel 实例的数据接收处理函数</span>\n  <span class=\"token function\">onDataReceived</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dataList</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lastQueryError <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lastQuery <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> anySeriesFromQuery<span class=\"token punctuation\">:</span> any <span class=\"token operator\">=</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>dataList<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> refId<span class=\"token punctuation\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>refId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>anySeriesFromQuery<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lastQuery <span class=\"token operator\">=</span> anySeriesFromQuery<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Panel 数据查询失败的调用函数</span>\n  <span class=\"token function\">onDataError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleQueryCtrlError</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">handleQueryCtrlError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 省略其它详细代码</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>对应视图 View 中的部分代码如下，<code>&#x3C;query-editor-row query-ctrl=\"ctrl\">&#x3C;/query-editor-row></code> 标签的内容会加入到Add Query模板中：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>query-editor-row</span> <span class=\"token attr-name\">query-ctrl</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>generic-datasource-query-row<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">has-text-edit-mode</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>gf-form-inline<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>gf-form<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>label</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>gf-form-label query-keyword width-9<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Namespace<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>label</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>gf-form-select-wrapper gf-form-select-wrapper--caret-indent<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>select</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>gf-form-input min-width-12<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">ng-model</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.target.namespace<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">ng-options</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>f as f for f in ctrl.namespaces<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">ng-change</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.onNamespaceChange()<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>select</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token comment\">&lt;!-- 省略更多详情 --></span>\n\n  <span class=\"token comment\">&lt;!-- 新增不同的云产品，需要在该处增加新产品独有的配置页面 --></span>\n  <span class=\"token comment\">&lt;!-- CVM --></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>cvm-query</span>\n    <span class=\"token attr-name\">ng-if</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.target.service==='cvm'<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">target</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.target.cvm<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">show-detail</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.checkShowDetail('instance')<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">datasource</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.datasource<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">on-change</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.onInstanceQueryChange()<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">region</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.replace(ctrl.target.cvm.region)<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>cvm-query</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token comment\">&lt;!-- Global error message --></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>gf-form<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">ng-show</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ctrl.lastQueryError<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>pre</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>gf-form-pre alert alert-error<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>{{ctrl.lastQueryError}}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>pre</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>query-editor-row</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>基于 Tencent Cloud Monitor App 应用是面向腾讯云不同的云产品的，QueryCtrl 模块是整体的 Panel 查询入口，其中 <code>Namespace</code>、<code>Region</code>、<code>MetricName</code>、 <code>Period</code>、 <code>Insatnce</code> 等查询条件时每个云产品共有的，其处理逻辑直接在 QueryCtrl 中。针对 ShowDetail 控制显示部分的查询条件则是每个产品所独有的，因此抽象成一个个单独的 Angular 组件，由每个产品自定义实现功能。此时新增产品则需要在 <code>tc_monitor</code> 文件夹实现各自的 <code>query.ts</code> 组件，然后对应在 <code>query.editor.html</code> 中直接引入每个产品实现的组件即可。\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/005e087a07ebc40795f0a14b704ab28b/7ac7b/grafana_query.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 37.89403085177733%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABu0lEQVQoz31SW0tiURTeDzYSYjf1aOccO9lliJqcYWimt0T6c2W9VhhFETXVi/Va782beR8dERW8oII3FLz7dfaCrF5asPj2Zn372+vbezGoMRwOOaDT6aBcLqNQKKBYLCKbzSKVSqHZbKLRaBDn4fERku0r5m1LMJtnIUlWWK0Kre32H2Bc7FWwXq/D6/UiFoshnU6jUqmgVquNcDAY4O7uHtoJI8Z1E2CMQTOmhVY7TihLMhgn8ex2u3QoHA4jHo8jmUyOknfd6/Xo4kQigcMjN05OTuF2H+Pg4JDw7PwC15eXYHgXXDiTyaBUKpHlfD5PWa1W8d7JZ8H+RaOIRmMIhcLw+/14evqL52cfifDo9/uEuVxOrQcQiUQQCASJEwyG4PP51Sf6Tzzugs0pNoiiTA87q6Ki7vX6Sdzc3JJQq9Ui3N3dgyQrWFhYJj7n8g+ZnJqB07k9cshEiwiTyUIFo1GA0WSGRvMFV1d/Pgju7LggCCKU+UUYDCbimgULdDo9trYcb4IbPzfw+9cmvq/bsbqyim9r67DKc/B4PERqt9uELtc+REmBoI7H9LSBxsSiNsPdOBzOkeALpTrOQ7JO+MAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Tencent Cloud Monitor App 的 Datasource Plugin 的 QueryCtrl 结构图\"\n        title=\"\"\n        src=\"/static/005e087a07ebc40795f0a14b704ab28b/b9e4f/grafana_query.png\"\n        srcset=\"/static/005e087a07ebc40795f0a14b704ab28b/cf440/grafana_query.png 148w,\n/static/005e087a07ebc40795f0a14b704ab28b/d2d38/grafana_query.png 295w,\n/static/005e087a07ebc40795f0a14b704ab28b/b9e4f/grafana_query.png 590w,\n/static/005e087a07ebc40795f0a14b704ab28b/f9b6a/grafana_query.png 885w,\n/static/005e087a07ebc40795f0a14b704ab28b/2d849/grafana_query.png 1180w,\n/static/005e087a07ebc40795f0a14b704ab28b/7ac7b/grafana_query.png 1491w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>ConfigCtrl 模块</h3>\n<p>ConfigCtrl 模块实际上是一个 JavaScript 类，当用户在对该 App Plugin 的数据源进行编辑时，该模块会被实例化为 Angular 的控制器，并根据类中的 <code>templateUrl</code> 去加载对应的 View 视图，给用户呈现该数据源的自定的配置信息，具体页面展示以及代码如下：\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c5371a02dd8247fa0bd1676d6863d678/91670/datasource_config.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 85.38461538461539%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAACdklEQVQ4y5WUyXLTQBCGdY2teNEujSzNyLI22/EWx45DcUgRqEA4cOMtOENx5XV4xZ/ucZyYEChy+KtlS/3N34tkFKMR1OIa8dkbzGcLbDaXWK3WWC7PUddjjMdTTCZTNM2ExL/3sSwrFEWJ4TDXsiwb7bYJY0Q3gs9f0P/0DZtX17j7cIebm3e4vX2P7XaH9foCu92VBh2DGVbXDaqq1te27eyBVVWRsxqLcYVSKQwGkpRCiAHiONExCCJ4nq+T2EmvZ6Hb7eH0tAPTPEWr1dbRNAmo1BCZTDFtashUIk2VBjIsimKS0EBWGAoCB3AcD7ZDB3B8cojBDyZphkgQgNwcnLEOYI6RiCnZ1fdTmSEJA0R+QAeE8P1HEVBgMp1jkCitAyBJJCQl8rXKhhrUaplQKsd0tkIdu0g9G7ZLUNeHey+Dy2AIA7h8hliWg37f1pFd8bVtubpcTtIlE8ih6/1/gY4sgx1st1eYzZZaDU1TO0tS3TdO5gP5YIYxXB9AvTu4OsA0kB+83L3GfLGGiCW5cpHRXhVFpcu0KJGB3B8GcdknJ20aQP95oO9HKCvaq7JBGA30n1wmix/maJodWpEuOp3e/TT7uh3PAtlFnhfIslwvaBSnVKb/0C+OhwkeJx7fP4YaXM7qfENbP0E9nqGRMULHpob/nvicnsL2PaTlXa4uINUIMq9xnnqQLk34yOW/9IfDgHqYZwVEMNBDkcKH77p6JY4Tnjr5mwwvoH1KqT8ZvWIixMgTUL546Nn/gh5Lnkpsvt9i/eMjNm/P8HN+ja/lAmcL2kn6fPGUXwRkh74iRxkNQ0So3RBDej/1B4FcvtThLyPmxEia9bgoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Tencent Cloud Monitor App 的 Datasource Plugin 的数据源配置\"\n        title=\"\"\n        src=\"/static/c5371a02dd8247fa0bd1676d6863d678/b9e4f/datasource_config.png\"\n        srcset=\"/static/c5371a02dd8247fa0bd1676d6863d678/cf440/datasource_config.png 148w,\n/static/c5371a02dd8247fa0bd1676d6863d678/d2d38/datasource_config.png 295w,\n/static/c5371a02dd8247fa0bd1676d6863d678/b9e4f/datasource_config.png 590w,\n/static/c5371a02dd8247fa0bd1676d6863d678/f9b6a/datasource_config.png 885w,\n/static/c5371a02dd8247fa0bd1676d6863d678/2d849/datasource_config.png 1180w,\n/static/c5371a02dd8247fa0bd1676d6863d678/91670/datasource_config.png 1300w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n      </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* 文件路径为 /src/datasource/config.ctrl.ts */</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> _ <span class=\"token keyword\">from</span> <span class=\"token string\">'lodash'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">SERVICES</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./tc_monitor'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TCMonitorDatasourceConfigCtrl</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">static</span> templateUrl <span class=\"token operator\">=</span> <span class=\"token string\">'datasource/partials/config.html'</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 指定该Controller 对应 View 文件，且实际路径为 /src/datasource/partials/config.html</span>\n  current<span class=\"token punctuation\">:</span> any<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/** @ngInject */</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">$scope</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>jsonData<span class=\"token punctuation\">.</span>services <span class=\"token operator\">=</span> <span class=\"token constant\">SERVICES</span><span class=\"token punctuation\">;</span>\n    _<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>jsonData<span class=\"token punctuation\">.</span>services<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">service</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>jsonData<span class=\"token punctuation\">[</span>service<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1>结束</h1>\n<p>Tencent Cloud Monitor App 已经在 github.com 上开源了，欢迎大家多提 issues，顺便给我们 Star 鼓励一下。<br>\n<a href=\"https://github.com/TencentCloud/tencentcloud-monitor-grafana-app\">TencentCloud/tencentcloud-monitor-grafana-app</a></p>","frontmatter":{"title":"Grafana App 插件开发","date":"May 15, 2019","description":"Grafana App 插件开发"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/grafana/app_develop/","previous":{"fields":{"slug":"/javascript/object_oriented/"},"frontmatter":{"title":"JavaScript 基于原型的面向对象设计"}},"next":null}}