{"data":{"site":{"siteMetadata":{"title":"Blog","author":"susiezhao"}},"markdownRemark":{"id":"f2cb7447-4273-54aa-9e3c-8106caaaeb77","excerpt":"Grafana APP 插件 Grafana APP 插件的目录结构及配置文件 Grafana APP 开发实践 Datasource 插件的开发 Datasource 模块 Grafana APP 插件 Grafana 是一个开源的时序性统计和监控平台，支持例如 elasticsearch、graphite…","html":"<!-- TOC -->\n<ul>\n<li>\n<p><a href=\"#grafana-app-%E6%8F%92%E4%BB%B6\">Grafana APP 插件</a></p>\n<ul>\n<li><a href=\"#grafana-app-%E6%8F%92%E4%BB%B6%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6\">Grafana APP 插件的目录结构及配置文件</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#grafana-app-%E5%BC%80%E5%8F%91%E5%AE%9E%E8%B7%B5\">Grafana APP 开发实践</a></p>\n<ul>\n<li><a href=\"#datasource-%E6%8F%92%E4%BB%B6%E7%9A%84%E5%BC%80%E5%8F%91\">Datasource 插件的开发</a></li>\n<li><a href=\"#datasource-%E6%A8%A1%E5%9D%97\">Datasource 模块</a></li>\n</ul>\n</li>\n</ul>\n<!-- /TOC -->\n<h1>Grafana APP 插件</h1>\n<p>Grafana 是一个开源的时序性统计和监控平台，支持例如 elasticsearch、graphite、influxdb 等众多的数据源，并以功能强大的界面编辑器著称，允许您对指标进行查询、可视化展示、设置告警等操作，以及自定义配置仪表盘。 </p>\n<p>Grafana 已经拥有一个强大的贡献者和插件开发者社区。开发者社区提供了三种类型的插件： </p>\n<ul>\n<li>Panel Plugin: 针对图形展示的面板插件；</li>\n<li>Datasource Plugin: 针对数据源的插件；</li>\n<li>App Plugin: 针对完整应用的插件，通常由 Panel 插件，Datasource 插件以及 dashboard 模板组成；</li>\n</ul>\n<h2>Grafana APP 插件的目录结构及配置文件</h2>\n<p>本文主要介绍的是 App Plugin 的开发过程以及相关的代码组织。基于腾讯云云监控 API 的 Tencent Cloud Monitor App 插件()主要由两部分组成 datasource 插件 和 dashboards 模板组成，其目录结构如下所示：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">.\n├── CHANGELOG.md\n├── LICENSE\n├── README.md\n├── dist\n│   ├── README.md\n│   ├── components\n│   │   ├── config.html\n│   │   ├── config.js\n│   │   └── config.js.map\n│   ├── dashboards\n│   │   ├── example_cdb_dashboard.json\n│   │   └── example_cvm_dashboard.json\n│   ├── datasource\n│   │   ├── img\n│   │   │   └── tencent-cloud.svg\n│   │   ├── module.js\n│   │   ├── module.js.map\n│   │   ├── partials\n│   │   │   ├── annotations.editor.html\n│   │   │   ├── config.html\n│   │   │   ├── query.editor.html\n│   │   │   └── query.options.html\n│   │   └── plugin.json\n│   ├── img\n│   │   └── tencent-cloud.svg\n│   ├── module.js\n│   ├── module.js.map\n│   └── plugin.json\n├── jest.config.js\n├── package.json\n├── src\n│   ├── components\n│   │   ├── config.html\n│   │   └── config.ts\n│   ├── dashboards        // dashboard 模板\n│   │   ├── example_cdb_dashboard.json\n│   │   └── example_cvm_dashboard.json\n│   ├── datasource       // datasource plugin\n│   │   ├── __mocks__\n│   │   │   └── core_module.ts\n│   │   ├── components\n│   │   │   ├── custom_select_dropdown.ts\n│   │   │   └── multi_condition.ts\n│   │   ├── config.ctrl.ts\n│   │   ├── css\n│   │   │   └── query_editor.css\n│   │   ├── datasource.ts\n│   │   ├── img\n│   │   │   └── tencent-cloud.svg\n│   │   ├── module.ts\n│   │   ├── partials\n│   │   │   ├── annotations.editor.html\n│   │   │   ├── config.html\n│   │   │   ├── query.editor.html\n│   │   │   └── query.options.html\n│   │   ├── plugin.json\n│   │   ├── query.ctrl.ts\n│   │   ├── specs\n│   │   │   ├── tc_monitor_cdb_datasource.test.ts\n│   │   │   └── tc_monitor_cvm_datasource.test.ts\n│   │   ├── tc_monitor\n│   │   │   ├── cdb\n│   │   │   │   ├── cdb_query.ts\n│   │   │   │   ├── datasource.ts\n│   │   │   │   └── query_def.ts\n│   │   │   ├── cvm\n│   │   │   │   ├── cvm_query.ts\n│   │   │   │   ├── datasource.ts\n│   │   │   │   └── query_def.ts\n│   │   │   └── index.ts\n│   │   └── utils\n│   │       ├── constants.ts\n│   │       └── sign.ts\n│   ├── img\n│   │   └── tencent-cloud.svg\n│   ├── module.ts\n│   └── plugin.json\n├── tsconfig.jest.json\n├── tsconfig.json\n├── tslint.json\n├── webpack.config.analyze.js\n├── webpack.config.js\n└── webpack.config.prod.js</code></pre></div>\n<p>在插件开发中存在两个重要的配置文件： <code>plugin.json</code> 和 <code>module.ts</code>。</p>\n<ul>\n<li>\n<p><code>plugin.json</code>: 每一个插件中必不可少的文件，用于描述插件的相关信息。在 Grafana 服务启动时会扫描所有的插件文件夹并挂载每个插件的 dist 目录，并查找 <code>plugin.json</code> 文件，根据文件的内容完成插件的自动注册。 一个App plugin 的 plugion.json 如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"app\"</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">// 插件的类型： panel | app | datasource</span>\n<span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Tencent Cloud Monitor\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 插件名称</span>\n<span class=\"token string\">\"id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"tencentcloud-monitor-app\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 插件ID, 必须唯一</span>\n<span class=\"token string\">\"info\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"description\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Tencent Cloud Monitor App for Grafana\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"author\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Tencent Cloud\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"keywords\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">\"tencentcloud\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"tencentcloudmonitor\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"grafana\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"plugins\"</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"logos\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"small\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"img/tencent-cloud.svg\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"large\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"img/tencent-cloud.svg\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"version\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.0.0\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"updated\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2019-04-10\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"includes\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"dashboard\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"【实例】CDB 单机监控\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"path\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"dashboards/example_cdb_dashboard.json\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"dashboard\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"【实例】CVM 单机监控\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"path\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"dashboards/example_cvm_dashboard.json\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"datasource\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Tencent Cloud Monitor Datasource\"</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"dependencies\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"token string\">\"grafanaVersion\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"6.0\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token string\">\"plugins\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其中 Datasource 插件独有两个属性，且其中至少有一个为 <code>true</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;metrics&quot;: true,   // 是否在panel中支持metrics\n&quot;annotations&quot;: false,  // 在dashboard中支持annotations查询</code></pre></div>\n</li>\n<li><code>module.ts</code>：插件的入口文件，决定了插件的具体实现的。根据插件的类型不同其内容也有所差异。 </li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// App Plugin 的 module.ts 需要导入1个模块</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span>\n  ConfigCtrl<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Datasource 的 module.ts 通常需要导出5个模块</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span>\n  Datasource<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Required</span>\n  ConfigCtrl<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Required</span>\n  QueryCtrl<span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Required</span>\n  AnnotationsQueryCtrl<span class=\"token punctuation\">,</span>\n  QueryOptionsCtrl\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h1>Grafana APP 开发实践</h1>\n<p>完整的 Grafana App 的整体图如下所示：\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2263f0574549724877c027a099aec2dd/0e0c1/grafana_app.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 82.86235186873292%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAADUElEQVQ4y4VTSUxTURT9hqmlWOjc/t9CS6FQqqKmKFQEdwZRdIl7JG4AZ9GIiQxuxQUbQRMUZFLDzp1Ca1ASxRY2JOCCKQwb5nk4vvuwIIToTU7+y/s3595z3r2Cy30OnvQzcKemIsV1FDZbPAwGE0JCQlFV9RQUo6OjmJycxObmJgYHf+FV4zu0tb1H09smjrq6l6ipqUFtbS0E0SLCKZqgUUYjPEKO0NAwyGRyCIKAsrLHmJ6eRl9fH/9SNDU1Q6Eywm6zwyGZIKlUkMsjIRwKgVqtg/C8thpvnlWj/EkFyssrUFFRicrKKjx6VIaOjk7Mz89jamoKKysrnLChoREatQZOZwokUYLJKMJoMEC0OpGddQkC/hMLCwuYm5vD6uoqtra2uPRPnz7D5/uCzk4vOr1eeBno3NX1FcLGxgY2GdbX1/eA7hcXFzmIZHx8HMvLy/z+XyFQ1f0g8ymIpKenByMjIxgeHsbQ0BD3cm1tjVtA3/2NcMlEclBMTEygt7cXY2Nj3EvqjrqkfDof1K0QJKNqS0tLvHLQN5La39/POyUPZ2ZmMDs7y3Mol85UgM5BMA+35VXXvMD5y/m4mp+PvLwryMm5gNzci8jwePjrDwwM4PTpDHg8mcg8m4WsrGykp3vgdqcxnPrzTdt+FIpbt25DoTjMh1qj0SEmRg2tRsvnsaDgGvx+P0JlUTCYbdBq9TyXEBWl3IMdwnv3SqHXm9im2CFJFhjZfJnZVyaLREnJDQT8PxGjE5F8zM0IddDq9DCZJA7KDWKHsPTBQ35BZJSsUml4p+HhMhQVFSMQCCBCpoDI/tsTkjisrLjNloBERzLi4uIhipZdwrt37kOt0rHpF6FnsoPkEWwdi4tLEGCvHRYWAYPeCNeR47DE2qBUxvCiZAFBpzPsEhbfv8n8U8JplKA4HM39iI5WcQ8LC6/z8ZHJFaxILBwOJ+80SER3tIZGvWF3bL77f6C9vQ0fP7SjubUVLS0taG1tQ339aya3F93fuhHJikjmOCQwufH2RNalFbEMKa5jsNsdjNT878H+O3w+H5evZ5KTklwwW6xcAXVId1oml7DTIa1bcPrX+W5vn2mgKWjx6aGs1nicOJmGxMRkmM2xsFji9uA3wheCICLYZg8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"完整的 Grafana App\"\n        title=\"\"\n        src=\"/static/2263f0574549724877c027a099aec2dd/b9e4f/grafana_app.png\"\n        srcset=\"/static/2263f0574549724877c027a099aec2dd/cf440/grafana_app.png 148w,\n/static/2263f0574549724877c027a099aec2dd/d2d38/grafana_app.png 295w,\n/static/2263f0574549724877c027a099aec2dd/b9e4f/grafana_app.png 590w,\n/static/2263f0574549724877c027a099aec2dd/f9b6a/grafana_app.png 885w,\n/static/2263f0574549724877c027a099aec2dd/0e0c1/grafana_app.png 1097w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n      </p>\n<p>在整个应用开发中最为重要的部分是 Datasource 插件模块的开发，下面我们以该模块为例详细介绍。</p>\n<h2>Datasource 插件的开发</h2>\n<p>Datasource 插件中有3个必须的模块：<code>Datasource</code>、 <code>QueryCtrl</code> 和 <code>ConfigCtrl</code>；\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8d31ceb3f2953231049991ba36b35f9/0eed5/datasource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 29.08458864426419%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAAA90lEQVQY022Qy26DMBBF+f9/qlRllXZBgBRIwxubYIwDBhPMy7hOUqqq6tHV1Wxm5s5o6yq/Je+IR/GUfLgQKyY0x1eIcJhkfpQGMYSITLPQ5C9msZ5AbXiF4Rf6Ge1t8OZkgPR+gqxTfPxM9A9/tzdMJxjGWQ3VnLRxU+qCxorqlHA+LjWbaDfVbKzYoLzjC2kHXN2qlldtT2hHu+GZS9tZ+auZKb0coAuYyh9cWivAdkTuHl9ND73bMEZMbrf8oLX9wgbBuKhvi3LKxqzsYMkAZglqlEDBWD/Ni9i+o9ia/9zsZY0VlnZMjmF58JB+ztV+Pgr5H18o81EbMljENAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"完整的 Datasource\"\n        title=\"\"\n        src=\"/static/e8d31ceb3f2953231049991ba36b35f9/b9e4f/datasource.png\"\n        srcset=\"/static/e8d31ceb3f2953231049991ba36b35f9/cf440/datasource.png 148w,\n/static/e8d31ceb3f2953231049991ba36b35f9/d2d38/datasource.png 295w,\n/static/e8d31ceb3f2953231049991ba36b35f9/b9e4f/datasource.png 590w,\n/static/e8d31ceb3f2953231049991ba36b35f9/0eed5/datasource.png 863w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>Datasource 模块</h3>\n<p>在基于 Tencent Cloud Monitor App 的</p>","frontmatter":{"title":"Grafana App 插件开发","date":"May 15, 2019","description":"Grafana App 插件开发"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/grafana/app_develop/","previous":{"fields":{"slug":"/javascript/object_oriented/"},"frontmatter":{"title":"JavaScript 基于原型的面向对象设计"}},"next":null}}